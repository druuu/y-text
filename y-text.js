/**
 * y-text - Text Type for Yjs
 * @version v10.0.0-0
 * @license MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.yText=e()}(this,function(){"use strict";function t(t,n,r){if(t==n)return t?[[d,t]]:[];(r<0||t.length<r)&&(r=null);var s=i(t,n),a=t.substring(0,s);t=t.substring(s),n=n.substring(s),s=o(t,n);var c=t.substring(t.length-s);t=t.substring(0,t.length-s),n=n.substring(0,n.length-s);var f=e(t,n);return a&&f.unshift([d,a]),c&&f.push([d,c]),l(f),null!=r&&(f=u(f,r)),f}function e(e,r){var i;if(!e)return[[g,r]];if(!r)return[[h,e]];var o=e.length>r.length?e:r,l=e.length>r.length?r:e,a=o.indexOf(l);if(-1!=a)return i=[[g,o.substring(0,a)],[d,l],[g,o.substring(a+l.length)]],e.length>r.length&&(i[0][0]=i[2][0]=h),i;if(1==l.length)return[[h,e],[g,r]];var u=s(e,r);if(u){var c=u[0],f=u[1],v=u[2],p=u[3],b=u[4],y=t(c,v),m=t(f,p);return y.concat([[d,b]],m)}return n(e,r)}function n(t,e){for(var n=t.length,i=e.length,o=Math.ceil((n+i)/2),s=o,l=2*o,a=new Array(l),u=new Array(l),c=0;c<l;c++)a[c]=-1,u[c]=-1;a[s+1]=0,u[s+1]=0;for(var f=n-i,d=f%2!=0,v=0,p=0,b=0,y=0,m=0;m<o;m++){for(var x=-m+v;x<=m-p;x+=2){var _,w=s+x;_=x==-m||x!=m&&a[w-1]<a[w+1]?a[w+1]:a[w-1]+1;for(var M=_-x;_<n&&M<i&&t.charAt(_)==e.charAt(M);)_++,M++;if(a[w]=_,_>n)p+=2;else if(M>i)v+=2;else if(d){var k=s+f-x;if(k>=0&&k<l&&-1!=u[k]){var C=n-u[k];if(_>=C)return r(t,e,_,M)}}}for(var A=-m+b;A<=m-y;A+=2){var C,k=s+A;C=A==-m||A!=m&&u[k-1]<u[k+1]?u[k+1]:u[k-1]+1;for(var I=C-A;C<n&&I<i&&t.charAt(n-C-1)==e.charAt(i-I-1);)C++,I++;if(u[k]=C,C>n)y+=2;else if(I>i)b+=2;else if(!d){var w=s+f-A;if(w>=0&&w<l&&-1!=a[w]){var _=a[w],M=s+_-w;if(C=n-C,_>=C)return r(t,e,_,M)}}}}return[[h,t],[g,e]]}function r(e,n,r,i){var o=e.substring(0,r),s=n.substring(0,i),l=e.substring(r),a=n.substring(i),u=t(o,s),c=t(l,a);return u.concat(c)}function i(t,e){if(!t||!e||t.charAt(0)!=e.charAt(0))return 0;for(var n=0,r=Math.min(t.length,e.length),i=r,o=0;n<i;)t.substring(o,i)==e.substring(o,i)?(n=i,o=n):r=i,i=Math.floor((r-n)/2+n);return i}function o(t,e){if(!t||!e||t.charAt(t.length-1)!=e.charAt(e.length-1))return 0;for(var n=0,r=Math.min(t.length,e.length),i=r,o=0;n<i;)t.substring(t.length-i,t.length-o)==e.substring(e.length-i,e.length-o)?(n=i,o=n):r=i,i=Math.floor((r-n)/2+n);return i}function s(t,e){function n(t,e,n){for(var r,s,l,a,u=t.substring(n,n+Math.floor(t.length/4)),c=-1,f="";-1!=(c=e.indexOf(u,c+1));){var h=i(t.substring(n),e.substring(c)),g=o(t.substring(0,n),e.substring(0,c));f.length<g+h&&(f=e.substring(c-g,c)+e.substring(c,c+h),r=t.substring(0,n-g),s=t.substring(n+h),l=e.substring(0,c-g),a=e.substring(c+h))}return 2*f.length>=t.length?[r,s,l,a,f]:null}var r=t.length>e.length?t:e,s=t.length>e.length?e:t;if(r.length<4||2*s.length<r.length)return null;var l,a=n(r,s,Math.ceil(r.length/4)),u=n(r,s,Math.ceil(r.length/2));if(!a&&!u)return null;l=u?a&&a[4].length>u[4].length?a:u:a;var c,f,h,g;return t.length>e.length?(c=l[0],f=l[1],h=l[2],g=l[3]):(h=l[0],g=l[1],c=l[2],f=l[3]),[c,f,h,g,l[4]]}function l(t){t.push([d,""]);for(var e,n=0,r=0,s=0,a="",u="";n<t.length;)switch(t[n][0]){case g:s++,u+=t[n][1],n++;break;case h:r++,a+=t[n][1],n++;break;case d:r+s>1?(0!==r&&0!==s&&(e=i(u,a),0!==e&&(n-r-s>0&&t[n-r-s-1][0]==d?t[n-r-s-1][1]+=u.substring(0,e):(t.splice(0,0,[d,u.substring(0,e)]),n++),u=u.substring(e),a=a.substring(e)),0!==(e=o(u,a))&&(t[n][1]=u.substring(u.length-e)+t[n][1],u=u.substring(0,u.length-e),a=a.substring(0,a.length-e))),0===r?t.splice(n-s,r+s,[g,u]):0===s?t.splice(n-r,r+s,[h,a]):t.splice(n-r-s,r+s,[h,a],[g,u]),n=n-r-s+(r?1:0)+(s?1:0)+1):0!==n&&t[n-1][0]==d?(t[n-1][1]+=t[n][1],t.splice(n,1)):n++,s=0,r=0,a="",u=""}""===t[t.length-1][1]&&t.pop();var c=!1;for(n=1;n<t.length-1;)t[n-1][0]==d&&t[n+1][0]==d&&(t[n][1].substring(t[n][1].length-t[n-1][1].length)==t[n-1][1]?(t[n][1]=t[n-1][1]+t[n][1].substring(0,t[n][1].length-t[n-1][1].length),t[n+1][1]=t[n-1][1]+t[n+1][1],t.splice(n-1,1),c=!0):t[n][1].substring(0,t[n+1][1].length)==t[n+1][1]&&(t[n-1][1]+=t[n+1][1],t[n][1]=t[n][1].substring(t[n+1][1].length)+t[n+1][1],t.splice(n+1,1),c=!0)),n++;c&&l(t)}function a(t,e){if(0===e)return[d,t];for(var n=0,r=0;r<t.length;r++){var i=t[r];if(i[0]===h||i[0]===d){var o=n+i[1].length;if(e===o)return[r+1,t];if(e<o){t=t.slice();var s=e-n,l=[i[0],i[1].slice(0,s)],a=[i[0],i[1].slice(s)];return t.splice(r,1,l,a),[r+1,t]}n=o}}throw new Error("cursor_pos is out of bounds!")}function u(t,e){var n=a(t,e),r=n[1],i=n[0],o=r[i],s=r[i+1];if(null==o)return t;if(o[0]!==d)return t;if(null!=s&&o[1]+s[1]===s[1]+o[1])return r.splice(i,2,s,o),c(r,i,2);if(null!=s&&0===s[1].indexOf(o[1])){r.splice(i,2,[s[0],o[1]],[0,o[1]]);var l=s[1].slice(o[1].length);return l.length>0&&r.splice(i+2,0,[s[0],l]),c(r,i,3)}return t}function c(t,e,n){for(var r=e+n-1;r>=0&&r>=e-1;r--)if(r+1<t.length){var i=t[r],o=t[r+1];i[0]===o[1]&&t.splice(r,2,[i[0],i[1]+o[1]])}return t}function f(t){t.requestModules(["Array"]).then(function(){var e=function(t){function e(t,n,r,i){b(this,e);var o=_(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,r));return o.textfields=[],o.aceInstances=[],o.codeMirrorInstances=[],o.monacoInstances=[],null!=i&&"_"!==n[0]&&"string"==typeof i&&o.insert(0,i),o}return x(e,t),y(e,[{key:"toString",value:function(){return this._content.map(function(t){return t.val}).join("")}},{key:"insert",value:function(t,n){for(var r=n.split(""),i=0;i<r.length;i++)/[\uD800-\uDFFF]/.test(r[i])&&(r[i]=r[i]+r[i+1],r[i+1]="",i++);m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insert",this).call(this,t,r)}},{key:"delete",value:function(t,n){if(null==n&&(n=1),"number"!=typeof n)throw new Error("length must be a number!");if("number"!=typeof t)throw new Error("pos must be a number!");if(t+n>this._content.length||t<0||n<0)throw new Error("The deletion range exceeds the range of the array!");if(0!==n)if(this._content.length>t+n&&""===this._content[t+n].val&&2===this._content[t+n-1].val.length){var r=this._content[t+n-1].val[0];m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"delete",this).call(this,t,n+1),m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insert",this).call(this,t,[r])}else if(t>0&&""===this._content[t].val&&2===this._content[t-1].val.length){var i=this._content[t-1].val[1];m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"delete",this).call(this,t-1,n+1),m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insert",this).call(this,t-1,[i])}else m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"delete",this).call(this,t,n)}},{key:"unbindAll",value:function(){this.unbindTextareaAll(),this.unbindAceAll(),this.unbindCodeMirrorAll(),this.unbindMonacoAll()}},{key:"unbindMonaco",value:function(t){var e=this.monacoInstances.findIndex(function(e){return e.editor===t});if(e>=0){var n=this.monacoInstances[e];this.unobserve(n.yCallback),n.disposeBinding(),this.monacoInstances.splice(e,1)}}},{key:"unbindMonacoAll",value:function(){for(var t=this.monacoInstances.length-1;t>=0;t--)this.unbindMonaco(this.monacoInstances[t].editor)}},{key:"bindMonaco",value:function(t,e){function n(t){if(s){s=!1;try{t()}catch(t){throw s=!0,new Error(t)}s=!0}}function r(t){n(function(){for(var e=0,n=1;n<t.range.startLineNumber;e++)"\n"===o._content[e].val&&n++;var r=e+t.range.startColumn-1;t.rangeLength>0&&o.delete(r,t.rangeLength),o.insert(r,t.text)})}function i(e){n(function(){var n,r,i=t.model.getPositionAt(e.index);"insert"===e.type?(n=i,r=e.values.join("")):"delete"===e.type&&(n=t.model.modifyPosition(i,e.length),r="");var o={startLineNumber:i.lineNumber,startColumn:i.column,endLineNumber:n.lineNumber,endColumn:n.column},s={major:w.major,minor:w.minor++};t.executeEdits("Yjs",[{id:s,range:o,text:r,forceMoveMarkers:!0}])})}var o=this;e=e||{};var s=!0;t.setValue(this.toString());var l=t.onDidChangeModelContent(r).dispose;this.observe(i),this.monacoInstances.push({editor:t,yCallback:i,monacoCallback:r,disposeBinding:l})}},{key:"unbindCodeMirror",value:function(t){var e=this.codeMirrorInstances.findIndex(function(e){return e.editor===t});if(e>=0){var n=this.codeMirrorInstances[e];this.unobserve(n.yCallback),n.editor.off("changes",n.codeMirrorCallback),this.codeMirrorInstances.splice(e,1)}}},{key:"unbindCodeMirrorAll",value:function(){for(var t=this.codeMirrorInstances.length-1;t>=0;t--)this.unbindCodeMirror(this.codeMirrorInstances[t].editor)}},{key:"bindCodeMirror",value:function(t,e){function n(t){if(s){s=!1;try{t()}catch(t){throw s=!0,new Error(t)}s=!0}}function r(e,r){n(function(){for(var e=0;e<r.length;e++){var n=r[e],i=t.indexFromPos(n.from);if(n.removed.length>0){for(var s=0,l=0;l<n.removed.length;l++)s+=n.removed[l].length;s+=n.removed.length-1,o.delete(i,s)}o.insert(i,n.text.join("\n"))}})}function i(e){n(function(){var n=t.posFromIndex(e.index);if("insert"===e.type){var r=n;t.replaceRange(e.values.join(""),n,r)}else if("delete"===e.type){var i=t.posFromIndex(e.index+e.length);t.replaceRange("",n,i)}})}var o=this;e=e||{};var s=!0;t.setValue(this.toString()),t.on("changes",r),this.observe(i),this.codeMirrorInstances.push({editor:t,yCallback:i,codeMirrorCallback:r})}},{key:"unbindAce",value:function(t){var e=this.aceInstances.findIndex(function(e){return e.editor===t});if(e>=0){var n=this.aceInstances[e];this.unobserve(n.yCallback),n.editor.off("change",n.aceCallback),this.aceInstances.splice(e,1)}}},{key:"unbindAceAll",value:function(){for(var t=this.aceInstances.length-1;t>=0;t--)this.unbindAce(this.aceInstances[t].editor)}},{key:"bindAce",value:function(t,e){function n(t){if(s){s=!1;try{t()}catch(t){throw s=!0,new Error(t)}s=!0}}function r(e){n(function(){var n,r,i=t.getSession().getDocument();"insert"===e.action?(n=i.positionToIndex(e.start,0),o.insert(n,e.lines.join("\n"))):"remove"===e.action&&(n=i.positionToIndex(e.start,0),r=e.lines.join("\n").length,o.delete(n,r))})}function i(e){var r=t.getSession().getDocument();n(function(){if("insert"===e.type){var t=r.indexToPosition(e.index,0);r.insert(t,e.values.join(""))}else if("delete"===e.type){var n=r.indexToPosition(e.index,0),i=r.indexToPosition(e.index+e.length,0),o=new u(n.row,n.column,i.row,i.column);r.remove(o)}})}var o=this;e=e||{};var s=!0;t.setValue(this.toString()),t.on("change",r),t.selection.clearSelection();var l;l="undefined"!=typeof ace&&null==e.aceClass?ace:e.aceClass;var a=e.aceRequire||l.require,u=a("ace/range").Range;this.observe(i),this.aceInstances.push({editor:t,yCallback:i,aceCallback:r})}},{key:"bind",value:function(){var t=arguments[0];t instanceof Element?this.bindTextarea.apply(this,arguments):null!=t&&null!=t.session&&null!=t.getSession&&null!=t.setValue?this.bindAce.apply(this,arguments):null!=t&&null!=t.posFromIndex&&null!=t.replaceRange?this.bindCodeMirror.apply(this,arguments):null!=t&&null!=t.onDidChangeModelContent?this.bindMonaco.apply(this,arguments):console.error("Cannot bind, unsupported editor!")}},{key:"unbindTextarea",value:function(t){var e=this.textfields.findIndex(function(e){return e.editor===t});if(e>=0){var n=this.textfields[e];this.unobserve(n.yCallback);n.editor.removeEventListener("input",n.eventListener),this.textfields.splice(e,1)}}},{key:"unbindTextareaAll",value:function(){for(var t=this.textfields.length-1;t>=0;t--)this.unbindTextarea(this.textfields[t].editor)}},{key:"bindTextarea",value:function(t,e){function n(t){if(o){o=!1;try{t()}catch(t){throw o=!0,new Error(t)}o=!0}}function r(t){n(function(){var e,n;if("insert"===t.type){e=t.index,n=function(t){return t<=e?t:t+=1};var r=l(n);a(r)}else"delete"===t.type&&(e=t.index,n=function(t){return t<e?t:t-=1},r=l(n),a(r))})}e=e||window,null==e.getSelection&&(e=window);for(var i=0;i<this.textfields.length;i++)if(this.textfields[i].editor===t)return;var o=!0,s=this;t.value=this.toString();var l,a,u,c;null!=t.selectionStart&&null!=t.setSelectionRange?(l=function(e){var n=t.selectionStart,r=t.selectionEnd;return null!=e&&(n=e(n),r=e(r)),{left:n,right:r}},a=function(e){u(s.toString()),t.setSelectionRange(e.left,e.right)},u=function(e){t.value=e},c=function(){return t.value}):(l=function(n){var r={},i=e.getSelection(),o=t.textContent.length;r.left=Math.min(i.anchorOffset,o),r.right=Math.min(i.focusOffset,o),null!=n&&(r.left=n(r.left),r.right=n(r.right));var s=i.focusNode;return s===t||s===t.childNodes[0]?r.isReal=!0:r.isReal=!1,r},a=function(n){u(s.toString());var r=t.childNodes[0];if(n.isReal&&null!=r){n.left<0&&(n.left=0),n.right=Math.max(n.left,n.right),n.right>r.length&&(n.right=r.length),n.left=Math.min(n.left,n.right);var i=document.createRange();i.setStart(r,n.left),i.setEnd(r,n.right);var o=e.getSelection();o.removeAllRanges(),o.addRange(i)}},u=function(e){t.innerText=e},c=function(){return t.innerText}),u(this.toString()),this.observe(r);var f=function(){n(function(){for(var t=l(function(t){return t}),e=s.toString(),n=c(),r=p(e,n,t.left),i=0,o=0;o<r.length;o++){var a=r[o];0===a[0]?i+=a[1].length:-1===a[0]?s.delete(i,a[1].length):(s.insert(i,a[1]),i+=a[1].length)}})};t.addEventListener("input",f),this.textfields.push({editor:t,yCallback:r,eventListener:f})}},{key:"_destroy",value:function(){this.unbindAll(),this.textfields=null,this.aceInstances=null,m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"_destroy",this).call(this)}}]),e}(t.Array.typeDefinition.class);t.extend("Text",new t.utils.CustomTypeDefinition({name:"Text",class:e,struct:"List",parseArguments:function(t){return"string"==typeof t?[this,t]:[this,null]},initType:function(n,r){var i=[];return t.Struct.List.map.call(this,r,function(t){if(t.hasOwnProperty("opContent"))throw new Error("Text must not contain types!");t.content.forEach(function(e,n){i.push({id:[t.id[0],t.id[1]+n],val:t.content[n]})})}),new e(n,r.id,i)},createType:function(t,n,r){return new e(t,n.id,[],r)}}))})}var h=-1,g=1,d=0,v=t;v.INSERT=g,v.DELETE=h,v.EQUAL=d;var p=v,b=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},y=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),m=function t(e,n,r){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,n);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,r)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(r)},x=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},_=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},w={major:0,minor:0};return"undefined"!=typeof Y&&f(Y),f});
//# sourceMappingURL=y-text.js.map
